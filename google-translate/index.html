<html>
<head>
    <title>English books reader</title>

    <style type="text/css">
        article#content {
            clear:both;
            float: left;
            width: 70%;
        }
        aside#sidebar {
            position: fixed;
            right: 0px;
            width: 27%;
        }
        a.play, a.close {
            text-decoration: none;
            color: blue;
        }
        menu {
            color:#6495ed;
            font-size: 9px;
            float:left;
            cursor:pointer;
        }
        menu li:hover{
            color: #0e1aff;
        }
        #cover{
            margin:0 40px;
            float:left;
        }

    </style>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function() {

            function readSingleFile(evt) {
                //Retrieve the first (and only!) File from the FileList object
                var f = evt.target.files[0];

                if (f) {
                    var r = new FileReader();
                    r.onload = function(e) {
                        var contents = e.target.result;
                        titles = $(contents).find('section');

                        // create menu from section titles
                        var html = '<menu>';
                        for (var i = 0; i < titles.length; i++){
                            html += '<li id="'+ i +'">' + titles.find('title').eq(i).text() + '</li>';
                        }
                        html += '</menu>';

                        // insert menu
                        $('article#content').before(html);
                        console.log(html);

                        // binding menu click and inserting paragraph
                        $("menu li").click(function(){
                            book = $(contents).find('section').eq(this.id).html();
                            $('article#content').html(book);
                         });

                        // insert cover
                        cover = $(contents).find('binary').html();
                        html='<div id="cover"><img src="data:image/jpg;base64,' + cover +'"></div> ';
                        $('article#content').before(html);

                        // insert first
                        book = $(contents).find('section').eq(0).html();
                        $('article#content').html(book);

                        // split text to individual words and wrap them in <span></span> tags
                        $("#content p").each(function() {
                            var self = $(this);
                            self.html(self.text().replace(/\b(\w+)\b/g, "<span>$1</span>"));
                        });

                        // click to word and translate it
                        $("#content p span").click(function() {
                            var word = $(this).text();

                            getTranslateFromYandexTranslate(word);
                        });


                    }
                    r.readAsText(f);
                } else {
                    alert("Failed to load file");
                }
            }



            // file upload listener
            document.getElementById('fileinput').addEventListener('change', readSingleFile, false);

            // hear the word
            $("a.play").live("click", function(event) {
                var word = $(this).parent().find("b").text();
                getVoiceFromForvo(word);
                return false;
            });

            // mouse hover word. show "close" button
            $("div.word").live("mouseenter", function(){
                $(this).append("<span class='close'> [<a class='close' href='#'>x</a>] </span>");
            });

            // mouse leave word. remove "close" button
            $("div.word").live("mouseleave", function(){
                $(this).find("span.close").remove();
            });

            // click on word "close" button
            $("#dictionary .word a.close").live("click", function(event) {
                $(this).parent().parent().remove();
                if($('#dictionary .word').length == 2) {
                    $("#sidebar p.close-all").remove(); // remove
                }

                return false;
            });

            // click on dictionary "close all" button
            $("#sidebar p.close-all a.close").live("click", function(event) {
                $.each($("#dictionary .word"), function() {
                    $(this).remove();
                });
                $(this).parent().remove();
                return false;
            });
        });

        // get word translate from translate.yandex.net
        function getTranslateFromYandexTranslate(word) {
            var url="http://translate.yandex.net/api/v1/tr.json/translate?lang=ru&text="+encodeURI(word);

            $.get(url, function(data) {
                if (typeof data.text != 'undefined') {
                    var translate = data.text[0];
                    var appendText = "<div class='word'><a class='play' href='#'>&raquo;</a> <b>"+word+"</b> - <i>" + translate + "</i></div>";

                    $('#dictionary').append(appendText);

                    if($('#dictionary .word').length == 2) {
                        $('#sidebar').append("<p class='close-all'>[ <a class='close' href='#'>close all</a> ]</p>");
                    }
                } else {
                    alert("Word \""+word+"\" is not found :(");
                }
            }, "json");
        }

        // get word voice from forvo.com and play it
        function getVoiceFromForvo(word) {
            var url = "http://apifree.forvo.com/key/3a28a419d2d3f2b197f2a721174730ca/format/json/callback/processingForvoData/action/standard-pronunciation/word/" + word + "?callback=?";

            $.getJSON(url, {}, function(data) {});
        }

        // play word voice
        function processingForvoData(data) {
            var mp3path = data.items[0].pathmp3;
            var oggpath = data.items[0].pathogg;

            var audio = new Audio(oggpath);
            audio.play();
        }

//        // отримати звучання слова з допомогою Google Dictionary (в mp3)
//        function getVoiceFromGoogleDictionary(word) {
//             var url = "http://www.google.com/dictionary/json?q="+word+"&sl=en&tl=en&callback=?";
//             $.getJSON(url, {}, function(data) {
//                 voice = data.primaries[0].terms[2].text;
//                 console.log(data);
//                 console.log(voice);
//             });
//        }

//        function getCodeForFlashAudioPlayer(filepath) {
//            // if (-1 < pos = filepath.indexOf('.mp3')) {}
//            return '<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=10,0,0,0" width="15" height="15"><PARAM NAME=movie VALUE="http://www.strangecube.com/audioplay/online/audioplay.swf?file='+filepath+'&auto=no&sendstop=yes&repeat=1&buttondir=http://www.strangecube.com/audioplay/online/alpha_buttons/negative_small&bgcolor=0xffffff&mode=playstop"><PARAM NAME=quality VALUE=high><PARAM NAME=wmode VALUE=transparent><embed src="http://www.strangecube.com/audioplay/online/audioplay.swf?file='+filepath+'&auto=no&sendstop=yes&repeat=1&buttondir=http://www.strangecube.com/audioplay/online/alpha_buttons/negative_small&bgcolor=0xffffff&mode=playstop" quality=high wmode=transparent width="15" height="15" align="" TYPE="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer"></embed></object>'
//        }
    </script>
</head>
<body>
    <article id="content">
        <input type="file" id="fileinput" />
    </article>
    <aside id="sidebar">
        <h2>Pocket dictionary:</h2>
        <div id="dictionary"></div>
    </aside>
</body>
</html>