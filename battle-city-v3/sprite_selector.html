<!DOCTYPE html>
<html>
<head>
    <title>Вибір спрайтів танків Battle City</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        #canvas-container { position: relative; display: inline-block; }
        canvas { border: 1px solid #ccc; cursor: crosshair; }
        .selection { 
            position: absolute; 
            border: 2px solid red; 
            background: rgba(255,0,0,0.2);
            pointer-events: none;
        }
        .sprite-preview {
            display: inline-block;
            margin: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .sprite-preview canvas {
            border: 1px solid #ccc;
            image-rendering: pixelated;
            width: 64px;
            height: 64px;
        }
        button { padding: 10px; margin: 5px; }
        .controls { margin: 20px 0; }
        .selected { background: #ffe; }
    </style>
</head>
<body>
    <h1>Вибір спрайтів танків Battle City</h1>
    
    <div class="controls">
        <input type="file" id="fileInput" accept="image/png">
        <button onclick="autoDetect()">Авто-розпізнавання танків</button>
        <button onclick="clearSelections()">Очистити</button>
    </div>
    
    <div class="controls">
        <label>Розмір сітки: <input type="number" id="gridSize" value="65" style="width:50px">px</label>
        <label><input type="checkbox" id="showGrid" checked> Показати сітку</label>
    </div>

    <div id="canvas-container"></div>
    
    <h2>Вибрані спрайти:</h2>
    <div id="selected-sprites"></div>
    
    <div class="controls">
        <button onclick="combineSprites()" style="background:#4CAF50;color:white;">
            Об'єднати вибрані в один файл (64x32)
        </button>
    </div>
    
    <div id="result"></div>

    <script>
        var selections = [];
        var img = null;
        var canvas = null;
        var ctx = null;
        var gridSize = 65;
        
        document.getElementById('fileInput').addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (!file) return;
            
            var reader = new FileReader();
            reader.onload = function(event) {
                img = new Image();
                img.onload = function() {
                    displayImage(img);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
        
        document.getElementById('gridSize').addEventListener('change', function() {
            gridSize = parseInt(this.value);
            if (img) displayImage(img);
        });
        
        document.getElementById('showGrid').addEventListener('change', function() {
            if (img) displayImage(img);
        });
        
        function displayImage(image) {
            var container = document.getElementById('canvas-container');
            container.innerHTML = '';
            
            canvas = document.createElement('canvas');
            canvas.width = image.width;
            canvas.height = image.height;
            ctx = canvas.getContext('2d');
            
            // Малюємо зображення
            ctx.drawImage(image, 0, 0);
            
            // Малюємо сітку
            if (document.getElementById('showGrid').checked) {
                ctx.strokeStyle = 'rgba(0,0,255,0.3)';
                ctx.lineWidth = 1;
                
                for (var x = 0; x <= canvas.width; x += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                
                for (var y = 0; y <= canvas.height; y += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
            }
            
            container.appendChild(canvas);
            
            // Додаємо обробник кліків
            canvas.onclick = function(e) {
                var rect = canvas.getBoundingClientRect();
                var x = Math.floor((e.clientX - rect.left) / gridSize) * gridSize;
                var y = Math.floor((e.clientY - rect.top) / gridSize) * gridSize;
                
                addSelection(x, y, gridSize, gridSize);
            };
        }
        
        function addSelection(x, y, w, h) {
            // Перевіряємо чи вже є такий вибір
            for (var i = 0; i < selections.length; i++) {
                if (selections[i].x === x && selections[i].y === y) {
                    // Видаляємо якщо вже вибрано
                    selections.splice(i, 1);
                    updatePreviews();
                    return;
                }
            }
            
            selections.push({x: x, y: y, w: w, h: h});
            updatePreviews();
        }
        
        function updatePreviews() {
            var container = document.getElementById('selected-sprites');
            container.innerHTML = '';
            
            selections.forEach(function(sel, index) {
                var div = document.createElement('div');
                div.className = 'sprite-preview';
                
                var preview = document.createElement('canvas');
                preview.width = sel.w;
                preview.height = sel.h;
                var pctx = preview.getContext('2d');
                pctx.drawImage(img, sel.x, sel.y, sel.w, sel.h, 0, 0, sel.w, sel.h);
                
                div.appendChild(preview);
                div.innerHTML += '<br>Спрайт ' + (index + 1) + '<br>';
                div.innerHTML += '<small>(' + sel.x + ',' + sel.y + ')</small><br>';
                
                var btn = document.createElement('button');
                btn.textContent = 'Видалити';
                btn.onclick = function() {
                    selections.splice(index, 1);
                    updatePreviews();
                };
                div.appendChild(btn);
                
                container.appendChild(div);
            });
            
            // Перемальовуємо виділення на основному canvas
            if (canvas) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                
                // Сітка
                if (document.getElementById('showGrid').checked) {
                    ctx.strokeStyle = 'rgba(0,0,255,0.3)';
                    ctx.lineWidth = 1;
                    
                    for (var x = 0; x <= canvas.width; x += gridSize) {
                        ctx.beginPath();
                        ctx.moveTo(x, 0);
                        ctx.lineTo(x, canvas.height);
                        ctx.stroke();
                    }
                    
                    for (var y = 0; y <= canvas.height; y += gridSize) {
                        ctx.beginPath();
                        ctx.moveTo(0, y);
                        ctx.lineTo(canvas.width, y);
                        ctx.stroke();
                    }
                }
                
                // Виділення
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2;
                selections.forEach(function(sel) {
                    ctx.strokeRect(sel.x, sel.y, sel.w, sel.h);
                    ctx.fillStyle = 'rgba(255,0,0,0.2)';
                    ctx.fillRect(sel.x, sel.y, sel.w, sel.h);
                });
            }
        }
        
        function autoDetect() {
            if (!img) return;
            
            selections = [];
            
            // Для сітки 65x65 з правильним центруванням танків
            var cellSize = 65;
            var tankSize = 52; // розмір танка в клітинці
            var offset = 6; // відступ від краю клітинки
            
            // Жовті танки - перший рядок
            selections.push({x: offset, y: offset, w: tankSize, h: tankSize});
            selections.push({x: cellSize + offset, y: offset, w: tankSize, h: tankSize});
            
            // Сірі танки - третій рядок  
            selections.push({x: offset, y: cellSize * 2 + offset, w: tankSize, h: tankSize});
            selections.push({x: cellSize + offset, y: cellSize * 2 + offset, w: tankSize, h: tankSize});
            
            // Зелені танки - п'ятий рядок
            selections.push({x: offset, y: cellSize * 4 + offset, w: tankSize, h: tankSize});
            selections.push({x: cellSize + offset, y: cellSize * 4 + offset, w: tankSize, h: tankSize});
            
            // Червоні танки - дев'ятий рядок
            selections.push({x: offset, y: cellSize * 8 + offset, w: tankSize, h: tankSize});
            selections.push({x: cellSize + offset, y: cellSize * 8 + offset, w: tankSize, h: tankSize});
            
            updatePreviews();
        }
        
        function clearSelections() {
            selections = [];
            updatePreviews();
        }
        
        function combineSprites() {
            if (selections.length < 2) {
                alert('Виберіть принаймні 2 спрайти для анімації!');
                return;
            }
            
            var resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<h2>Результат:</h2>';
            
            // Створюємо canvas 64x32 для двох кадрів
            var combined = document.createElement('canvas');
            combined.width = 64;
            combined.height = 32;
            var cctx = combined.getContext('2d');
            
            // Копіюємо перші два вибрані спрайти
            if (selections[0]) {
                cctx.drawImage(img, 
                    selections[0].x, selections[0].y, selections[0].w, selections[0].h,
                    0, 0, 32, 32);
            }
            if (selections[1]) {
                cctx.drawImage(img,
                    selections[1].x, selections[1].y, selections[1].w, selections[1].h,
                    32, 0, 32, 32);
            }
            
            combined.style.border = '1px solid #000';
            combined.style.imageRendering = 'pixelated';
            combined.style.width = '128px';
            combined.style.height = '64px';
            
            resultDiv.appendChild(combined);
            
            // Кнопка збереження
            var saveBtn = document.createElement('button');
            saveBtn.textContent = 'Зберегти як enemy_tank.png';
            saveBtn.style.display = 'block';
            saveBtn.style.marginTop = '10px';
            saveBtn.onclick = function() {
                combined.toBlob(function(blob) {
                    var a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'enemy_tank.png';
                    a.click();
                });
            };
            resultDiv.appendChild(saveBtn);
            
            // Створюємо окремі файли для кожного типу
            var types = ['enemy_basic', 'enemy_fast', 'enemy_power', 'enemy_bonus'];
            for (var i = 0; i < types.length && i * 2 < selections.length; i++) {
                var typeCanvas = document.createElement('canvas');
                typeCanvas.width = 64;
                typeCanvas.height = 32;
                var tctx = typeCanvas.getContext('2d');
                
                if (selections[i * 2]) {
                    tctx.drawImage(img,
                        selections[i * 2].x, selections[i * 2].y, 
                        selections[i * 2].w, selections[i * 2].h,
                        0, 0, 32, 32);
                }
                if (selections[i * 2 + 1]) {
                    tctx.drawImage(img,
                        selections[i * 2 + 1].x, selections[i * 2 + 1].y,
                        selections[i * 2 + 1].w, selections[i * 2 + 1].h,
                        32, 0, 32, 32);
                }
                
                var div = document.createElement('div');
                div.style.display = 'inline-block';
                div.style.margin = '10px';
                
                typeCanvas.style.border = '1px solid #ccc';
                typeCanvas.style.imageRendering = 'pixelated';
                typeCanvas.style.width = '128px';
                typeCanvas.style.height = '64px';
                div.appendChild(typeCanvas);
                
                var btn = document.createElement('button');
                btn.textContent = 'Зберегти ' + types[i] + '.png';
                btn.style.display = 'block';
                btn.onclick = (function(canvas, name) {
                    return function() {
                        canvas.toBlob(function(blob) {
                            var a = document.createElement('a');
                            a.href = URL.createObjectURL(blob);
                            a.download = name + '.png';
                            a.click();
                        });
                    };
                })(typeCanvas, types[i]);
                div.appendChild(btn);
                
                resultDiv.appendChild(div);
            }
        }
    </script>
</body>
</html>